name: iOS Build & Sign - Farra (Cordova Auto-Setup)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-15

    env:
      P12: ${{ secrets.P12_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      PROFILE: ${{ secrets.PP_BASE64 }}
      TEAM_ID: 72M97MR8UU

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ Checkout project
      # -------------------------------
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2Ô∏è‚É£ Setup Node & Cordova iOS platform
      # -------------------------------
      - name: ‚öôÔ∏è Setup Cordova environment
        run: |
          echo "‚¨áÔ∏è Installing Cordova environment..."
          npm install -g cordova
          npm install

          echo "üß± (Re)building iOS platform..."
            cordova platform remove ios
            cordova platform add ios@7.1.1

          echo "üìÇ Inspecting platforms/ios:"
          ls -R platforms/ios

      # -------------------------------
      # 3Ô∏è‚É£ Provisioning Profile & Certificate Setup
      # -------------------------------
      - name: üîë Import Certificate & Install Provisioning Profile
        run: |
          mkdir -p ~/signing
          echo "$PROFILE" | base64 --decode > ~/signing/profile.mobileprovision
          echo "$P12" | base64 --decode > ~/signing/dist.p12

          uuid=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$(security cms -D -i ~/signing/profile.mobileprovision)")
          echo "PROFILE_UUID=$uuid" >> $GITHUB_ENV
          echo "‚úÖ Provisioning Profile UUID: $uuid"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/signing/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          echo "‚úÖ Provisioning profile installed."

          echo -n "${{ secrets.P12_PASSWORD }}" | LC_ALL=C tr -d '\r\n' > ~/signing/p12pass.txt
          P12_PASS_CLEAN=$(<~/signing/p12pass.txt)

          security create-keychain -p temp-pass ios-build.keychain
          security unlock-keychain -p temp-pass ios-build.keychain
          security set-keychain-settings -lut 3600 ios-build.keychain
          security import ~/signing/dist.p12 -k ~/Library/Keychains/ios-build.keychain -A -P "$P12_PASS_CLEAN" -f pkcs12 -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign:,keychain: -k temp-pass ~/Library/Keychains/ios-build.keychain
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          echo "‚úÖ Certificate ready for codesign tools."

      # -------------------------------
      # 4Ô∏è‚É£ Setup Xcode
      # -------------------------------
      - name: ‚öôÔ∏è Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          xcodebuild -version

      # -------------------------------
      # 5Ô∏è‚É£ Build & Archive Signed App
      # -------------------------------
      - name: üöÄ Archive the app (Signed)
        run: |
          cd platforms/ios
          echo "üìò Building workspace/project..."
          security list-keychains -s ~/Library/Keychains/ios-build.keychain

          if [ -e "farra.xcworkspace" ]; then
            echo "üìò Using .xcworkspace"
            xcodebuild -workspace farra.xcworkspace \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          else
            echo "üìó Using .xcodeproj"
            xcodebuild -project farra.xcodeproj \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          fi
          echo "‚úÖ Archive phase completed."

      # -------------------------------
      # üìÑ Create ExportOptions.plist
      # -------------------------------
      - name: üßæ Create ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.farra.app</key>
                  <string>${PROFILE_UUID}</string>
              </dict>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>uploadSymbols</key>
              <true/>
              <key>generateAppStoreInformation</key>
              <true/>
          </dict>
          </plist>
          EOF
          echo "‚úÖ ExportOptions.plist created successfully with UUID ${PROFILE_UUID}"


      # -------------------------------
      # 6Ô∏è‚É£ Export signed IPA
      # -------------------------------
      - name: üì¶ Export IPA from Archive
        run: |
          cd platforms/ios
          echo "üì¶ Exporting IPA..."
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          security unlock-keychain -p temp-pass ~/Library/Keychains/ios-build.keychain

          xcodebuild -exportArchive \
            -archivePath $PWD/../../build/Farra.xcarchive \
            -exportOptionsPlist ../../ExportOptions.plist \
            -exportPath $PWD \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=$TEAM_ID \
            OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"

          echo "‚úÖ IPA exported at: $(ls -1 Farra.ipa || echo '‚ùå Missing!')"

      # -------------------------------
      # 7Ô∏è‚É£ Verify Bundle ID
      # -------------------------------
      - name: üîç Verify Bundle ID in IPA
        run: |
          echo "Verifying Bundle ID..."
          unzip -q platforms/ios/Farra.ipa 'Payload/*.app/Info.plist' -d /tmp
          INFO_PLIST=$(find /tmp/Payload -name Info.plist)
          BUNDLE_ID=$(plutil -extract CFBundleIdentifier xml1 -o - "$INFO_PLIST" | xmllint --xpath 'string(//string)' -)
          echo "Extracted Bundle ID: $BUNDLE_ID"

          if [ "$BUNDLE_ID" != "com.farra.app" ]; then
            echo "‚ùå Incorrect Bundle ID ($BUNDLE_ID)"
            exit 1
          fi
          echo "‚úÖ Bundle ID verified successfully."

      # -------------------------------
      # 8Ô∏è‚É£ Upload Signed IPA as Artifact
      # -------------------------------
      - name: ‚¨ÜÔ∏è Upload Signed IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: farra-signed
          path: platforms/ios/Farra.ipa

      # -------------------------------
      # 9Ô∏è‚É£ Upload to App Store Connect
      # -------------------------------
      - name: üì§ Upload to App Store Connect
        run: |
          cd platforms/ios
          
          echo "üöÄ Uploading to TestFlight with notifications..."
          
          fastlane pilot upload \
            --username "$FASTLANE_USER" \
            --app_identifier "com.farra.app" \
            --team_id "$TEAM_ID" \
            --ipa "Farra.ipa" \
            --skip_waiting_for_build_processing \
            --notify_external_testers true \
            --changelog "ŸÜÿ≥ÿÆŸá ÿ¨ÿØ€åÿØ ÿ¢ŸÖÿßÿØŸá ÿßÿ≥ÿ™! ŸÑÿ∑ŸÅÿß ÿ™ÿ≥ÿ™ ⁄©ŸÜ€åÿØ." \
            --distribute_external true
          
          echo "‚úÖ Upload completed! External testers will receive email notification."
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
