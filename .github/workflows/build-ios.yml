name: iOS Build & Sign - Farra (Cordova Auto-Setup)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-15

    env:
      P12: ${{ secrets.P12_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      PROFILE: ${{ secrets.PP_BASE64 }}
      TEAM_ID: 72M97MR8UU

    steps:
      # -------------------------------
      # 1ï¸âƒ£ Checkout project
      # -------------------------------
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2ï¸âƒ£ Setup Node & Cordova iOS platform
      # -------------------------------
      - name: âš™ï¸ Setup Cordova environment
        run: |
          echo "â¬‡ï¸ Installing Cordova environment..."
          npm install -g cordova
          npm install

          echo "ðŸ§± (Re)building iOS platform..."
          cordova platform remove ios || true
          cordova platform add ios
          echo "ðŸ“‚ Inspecting platforms/ios:"
          ls -R platforms/ios

      # -------------------------------
      # 3ï¸âƒ£ Provisioning Profile & Certificate Setup
      # -------------------------------
      - name: ðŸ”‘ Import Certificate & Install Provisioning Profile
        run: |
          mkdir -p ~/signing
          echo "$PROFILE" | base64 --decode > ~/signing/profile.mobileprovision
          echo "$P12" | base64 --decode > ~/signing/dist.p12

          uuid=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$(security cms -D -i ~/signing/profile.mobileprovision)")
          echo "PROFILE_UUID=$uuid" >> $GITHUB_ENV
          echo "âœ… Provisioning Profile UUID: $uuid"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/signing/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision
          echo "âœ… Provisioning profile installed."

          echo -n "${{ secrets.P12_PASSWORD }}" | LC_ALL=C tr -d '\r\n' > ~/signing/p12pass.txt
          P12_PASS_CLEAN=$(<~/signing/p12pass.txt)

          security create-keychain -p temp-pass ios-build.keychain
          security unlock-keychain -p temp-pass ios-build.keychain
          security set-keychain-settings -lut 3600 ios-build.keychain
          security import ~/signing/dist.p12 -k ~/Library/Keychains/ios-build.keychain -A -P "$P12_PASS_CLEAN" -f pkcs12 -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign:,keychain: -k temp-pass ~/Library/Keychains/ios-build.keychain
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          echo "âœ… Certificate ready for codesign tools."

      # -------------------------------
      # 4ï¸âƒ£ Setup Xcode
      # -------------------------------
      - name: âš™ï¸ Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          xcodebuild -version

      # -------------------------------
      # 5ï¸âƒ£ Build & Archive Signed App
      # -------------------------------
      - name: ðŸš€ Archive the app (Signed)
        run: |
          cd platforms/ios
          echo "ðŸ“˜ Building workspace/project..."
          security list-keychains -s ~/Library/Keychains/ios-build.keychain

          if [ -e "Farra.xcworkspace" ]; then
            echo "ðŸ“˜ Using .xcworkspace"
            xcodebuild -workspace Farra.xcworkspace \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/Farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          else
            echo "ðŸ“— Using .xcodeproj"
            xcodebuild -project Farra.xcodeproj \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/Farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          fi
          echo "âœ… Archive phase completed."

      # -------------------------------
      # 6ï¸âƒ£ Export signed IPA
      # -------------------------------
      - name: ðŸ“¦ Export IPA from Archive
        run: |
          cd platforms/ios
          echo "ðŸ“¦ Exporting IPA..."
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          security unlock-keychain -p temp-pass ~/Library/Keychains/ios-build.keychain

          xcodebuild -exportArchive \
            -archivePath $PWD/../../build/Farra.xcarchive \
            -exportOptionsPlist ../../ExportOptions.plist \
            -exportPath $PWD \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=$TEAM_ID \
            OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"

          echo "âœ… IPA exported at: $(ls -1 Farra.ipa || echo 'âŒ Missing!')"

      # -------------------------------
      # 7ï¸âƒ£ Verify Bundle ID
      # -------------------------------
      - name: ðŸ” Verify Bundle ID in IPA
        run: |
          echo "Verifying Bundle ID..."
          unzip -q platforms/ios/Farra.ipa 'Payload/*.app/Info.plist' -d /tmp
          INFO_PLIST=$(find /tmp/Payload -name Info.plist)
          BUNDLE_ID=$(plutil -extract CFBundleIdentifier xml1 -o - "$INFO_PLIST" | xmllint --xpath 'string(//string)' -)
          echo "Extracted Bundle ID: $BUNDLE_ID"

          if [ "$BUNDLE_ID" != "com.farra.app" ]; then
            echo "âŒ Incorrect Bundle ID ($BUNDLE_ID)"
            exit 1
          fi
          echo "âœ… Bundle ID verified successfully."

      # -------------------------------
      # 8ï¸âƒ£ Upload Signed IPA as Artifact
      # -------------------------------
      - name: â¬†ï¸ Upload Signed IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: farra-signed
          path: platforms/ios/Farra.ipa

      # -------------------------------
      # 9ï¸âƒ£ Upload to App Store Connect
      # -------------------------------
      - name: ðŸ“¤ Upload to App Store Connect
        run: |
          echo "ðŸš€ Uploading IPA to App Store Connect..."
          xcrun altool --upload-app \
            --type ios \
            --file "platforms/ios/Farra.ipa" \
            --username "farokgraphic@gmail.com" \
            --password "xhjf-xsvk-lcfe-yoda"
