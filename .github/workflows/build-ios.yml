name: iOS Build & Upload to TestFlight with Fastlane

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-15

    env:
      P12: ${{ secrets.P12_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      PROFILE: ${{ secrets.PP_BASE64 }}
      TEAM_ID: 72M97MR8UU
      FASTLANE_USER: ${{ secrets.APPLE_ID }}
      FASTLANE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ Checkout
      # -------------------------------
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2Ô∏è‚É£ Setup Cordova
      # -------------------------------
      - name: ‚öôÔ∏è Setup Cordova environment
        run: |
          echo "‚¨áÔ∏è Installing Cordova..."
          npm install -g cordova
          npm install

          echo "üß± Rebuilding iOS platform..."
          cordova platform remove ios
          cordova platform add ios@7.1.1

      # -------------------------------
      # 3Ô∏è‚É£ Install Fastlane
      # -------------------------------
      - name: üì¶ Install Fastlane
        run: |
          sudo gem install fastlane -NV
          fastlane --version

      # -------------------------------
      # 4Ô∏è‚É£ Certificate & Profile Setup
      # -------------------------------
      - name: üîë Import Certificate & Provisioning Profile
        run: |
          mkdir -p ~/signing
          echo "$PROFILE" | base64 --decode > ~/signing/profile.mobileprovision
          echo "$P12" | base64 --decode > ~/signing/dist.p12

          uuid=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$(security cms -D -i ~/signing/profile.mobileprovision)")
          echo "PROFILE_UUID=$uuid" >> $GITHUB_ENV
          echo "‚úÖ Profile UUID: $uuid"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/signing/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

          echo -n "${{ secrets.P12_PASSWORD }}" | LC_ALL=C tr -d '\r\n' > ~/signing/p12pass.txt
          P12_PASS_CLEAN=$(<~/signing/p12pass.txt)

          security create-keychain -p temp-pass ios-build.keychain
          security unlock-keychain -p temp-pass ios-build.keychain
          security set-keychain-settings -lut 3600 ios-build.keychain
          security import ~/signing/dist.p12 -k ~/Library/Keychains/ios-build.keychain -A -P "$P12_PASS_CLEAN" -f pkcs12 -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -k temp-pass ~/Library/Keychains/ios-build.keychain
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          echo "‚úÖ Certificate imported."

      # -------------------------------
      # 5Ô∏è‚É£ Setup Xcode
      # -------------------------------
      - name: ‚öôÔ∏è Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          xcodebuild -version

      # -------------------------------
      # 6Ô∏è‚É£ Auto-increment Build Number
      # -------------------------------
      - name: üî¢ Auto-increment Build Number
        run: |
          cd platforms/ios
          INFO_PLIST="farra/farra-Info.plist"
          
          if [ ! -f "$INFO_PLIST" ]; then
            echo "‚ùå Info.plist not found!"
            find . -name "*Info.plist" -type f
            exit 1
          fi
          
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST" 2>/dev/null || echo "1")
          echo "üìä Current Build: $CURRENT_BUILD"
          
          NEW_BUILD=$(date +%Y%m%d%H%M)
          echo "üìä New Build: $NEW_BUILD"
          
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" "$INFO_PLIST"
          
          VERIFY_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST")
          echo "‚úÖ Build updated to: $VERIFY_BUILD"

      # -------------------------------
      # 7Ô∏è‚É£ Archive App
      # -------------------------------
      - name: üöÄ Archive the app
        run: |
          cd platforms/ios
          security list-keychains -s ~/Library/Keychains/ios-build.keychain

          if [ -e "farra.xcworkspace" ]; then
            xcodebuild -workspace farra.xcworkspace \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          else
            xcodebuild -project farra.xcodeproj \
              -scheme farra \
              -configuration Release \
              -archivePath $PWD/../../build/farra.xcarchive \
              clean archive \
              -destination generic/platform=iOS \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Distribution" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
              DEVELOPMENT_TEAM="$TEAM_ID" \
              OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"
          fi
          echo "‚úÖ Archive completed."

      # -------------------------------
      # 8Ô∏è‚É£ Create ExportOptions.plist
      # -------------------------------
      - name: üßæ Create ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.farra.app</key>
                  <string>${PROFILE_UUID}</string>
              </dict>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>uploadSymbols</key>
              <true/>
              <key>generateAppStoreInformation</key>
              <true/>
          </dict>
          </plist>
          EOF
          echo "‚úÖ ExportOptions.plist created."

      # -------------------------------
      # 9Ô∏è‚É£ Export IPA
      # -------------------------------
      - name: üì¶ Export IPA from Archive
        run: |
          cd platforms/ios
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          security unlock-keychain -p temp-pass ~/Library/Keychains/ios-build.keychain

          xcodebuild -exportArchive \
            -archivePath $PWD/../../build/farra.xcarchive \
            -exportOptionsPlist ../../ExportOptions.plist \
            -exportPath $PWD \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=$TEAM_ID \
            OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/ios-build.keychain"

          echo "‚úÖ IPA exported: $(ls -1 Farra.ipa || echo '‚ùå Missing!')"

      # -------------------------------
      # üîü Upload Artifact
      # -------------------------------
      - name: ‚¨ÜÔ∏è Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: farra-signed
          path: platforms/ios/Farra.ipa

      # -------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Upload to TestFlight ÿ®ÿß Fastlane
      # -------------------------------
      - name: üöÄ Upload to TestFlight with Fastlane
        run: |
          cd platforms/ios
          
          echo "üöÄ Uploading to TestFlight with notifications..."
          
          fastlane pilot upload \
            --username "$FASTLANE_USER" \
            --app_identifier "com.farra.app" \
            --team_id "$TEAM_ID" \
            --ipa "Farra.ipa" \
            --skip_waiting_for_build_processing \
            --notify_external_testers true \
            --changelog "ŸÜÿ≥ÿÆŸá ÿ¨ÿØ€åÿØ ÿ¢ŸÖÿßÿØŸá ÿßÿ≥ÿ™! ŸÑÿ∑ŸÅÿß ÿ™ÿ≥ÿ™ ⁄©ŸÜ€åÿØ." \
            --distribute_external true
          
          echo "‚úÖ Upload completed! External testers will receive email notification."
