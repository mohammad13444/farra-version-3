<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/tokens.css">
    <link rel="stylesheet" href="./css/otp.css">
    <title>OTP Verification</title>
</head>

<body>

    <div class="otp-wrapper">
        <!-- Alert -->
        <!-- ğŸš¨ Ø¨Ø§Ú©Ø³ Ù‡Ø´Ø¯Ø§Ø± OTP -->
        <div class="otp-alert" id="otpAlert">
            

             <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
  <g opacity="0.4">
    <path d="M11.7344 7.94592V12.1567" stroke="#FF595B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M11.7297 15.9406H11.7387" stroke="#FF595B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  </g>
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C17.5222 2 22 6.47676 22 12C22 17.5222 17.5222 22 12 22C6.47676 22 2 17.5222 2 12C2 6.47676 6.47676 2 12 2Z" stroke="#FF595B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
            <div class="otp-alert-content">
                <div class="otp-alert-title">Wrong code?</div>
                <div class="otp-alert-message">Please double check and try again</div>
            </div>
        </div>

        <div class="otp-alert success" id="otpAlertSuccess">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
  <path opacity="0.4" d="M7.78615 21.1365C11.4884 22.8545 16.0155 22.1919 19.0712 19.1257C22.9725 15.2113 22.98 8.85771 19.0712 4.93577C15.1701 1.02141 8.83142 1.02141 4.92918 4.93577C1.87441 8.00196 1.21286 12.5443 2.92618 16.2591C3.14561 16.8079 3.3164 17.2504 3.3164 17.6789C3.3164 18.8762 2.16519 20.3589 2.93267 21.129C3.70014 21.8991 5.17888 20.744 6.36577 20.7374C6.79167 20.7374 7.23918 20.9153 7.78615 21.1365Z" stroke="#44CD54" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M8.37354 12.099L10.7592 14.4926L15.5294 9.7063" stroke="#44CD54" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
            <div class="otp-alert-content">
                <div class="sss">New OTP sent.</div>
            </div>
        </div>

        <br>
        <br>
        <!-- Top Icon -->
        <div style="display: inline-flex;
padding: 3px;
align-items: center;
gap: 10px;">
             <a href="./start.html">
    <svg style="width: 24px; height: 24px;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
  <path opacity="0.4" fill-rule="evenodd" clip-rule="evenodd" d="M22 12.2933C22 11.6436 21.4733 11.1168 20.8235 11.1168L3.17647 11.1168C2.52672 11.1168 2 11.6436 2 12.2933C2 12.943 2.52672 13.4697 3.17647 13.4697L20.8235 13.4697C21.4733 13.4697 22 12.943 22 12.2933Z" fill="#706DF2"/>
  <path d="M9.736 4.14121C10.308 3.83298 11.0215 4.04662 11.3299 4.61862C11.5387 5.00603 11.5079 5.45839 11.2885 5.80592C11.1841 5.97133 11.0368 6.11297 10.8525 6.21239L10.8502 6.21368L10.8379 6.22039L10.7846 6.24968C10.7367 6.27627 10.6648 6.31651 10.5722 6.36945C10.3871 6.47521 10.12 6.63133 9.79847 6.82909C9.15325 7.22603 8.29946 7.78404 7.45157 8.43462C6.59671 9.09051 5.78602 9.81156 5.19973 10.5291C4.59065 11.2745 4.35306 11.8587 4.35306 12.2627C4.35306 12.6674 4.5909 13.2524 5.19993 13.998C5.78623 14.716 6.59692 15.4374 7.45177 16.0936C8.29964 16.7444 9.15342 17.3027 9.79859 17.6997C10.1201 17.8975 10.3872 18.0537 10.5724 18.1596C10.6654 18.2128 10.7587 18.2657 10.8529 18.3168C11.4246 18.6252 11.6381 19.3387 11.3298 19.9104C11.0214 20.4824 10.3078 20.696 9.73589 20.3876C9.62447 20.3275 9.51433 20.265 9.40442 20.2022C9.20037 20.0855 8.91136 19.9164 8.56557 19.7036C7.87624 19.2795 6.9506 18.6751 6.01906 17.96C5.0945 17.2504 4.12578 16.4026 3.37752 15.4864C2.65199 14.598 2.00012 13.4838 2.00012 12.2627C2.00012 11.0419 2.65224 9.92815 3.37771 9.04027C4.12599 8.12451 5.09471 7.27721 6.01926 6.5678C6.95078 5.85309 7.8764 5.24897 8.56573 4.82497C8.91151 4.61227 9.20052 4.44321 9.40457 4.32662C9.50664 4.26827 9.58763 4.22297 9.644 4.19168L9.70977 4.15545L9.728 4.14556L9.7333 4.14274L9.736 4.14121Z" fill="#706DF2"/>
</svg>
</a>
      </div>

        <!-- Header -->
        <div class="title">Got message?</div>
        <div class="description">Enter the code I sent to the phone number you gave me.</div>

        <!-- Phone Info -->
        <div class="phone-info">
            <div class="phone-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M19.1686 17.9794L19.1675 6.01946C19.1675 3.8 17.3675 2 15.1481 2H9.01947C6.8 2 5 3.8 5 6.02054L5.00109 17.9806C5.00109 20.2 6.80109 22 9.02054 22H15.1481C17.3686 22 19.1686 20.2 19.1686 17.9794Z" stroke="#706DF2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
  <path opacity="0.4" d="M12.0846 17.9229V17.8694M12.0846 17.5881C11.9311 17.5881 11.8066 17.7126 11.8066 17.8657C11.8066 18.0192 11.9311 18.1437 12.0846 18.1437C12.2383 18.1437 12.3628 18.0192 12.3628 17.8657C12.3628 17.7126 12.2383 17.5881 12.0846 17.5881Z" stroke="#45454D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
            </div>
            <span class="phone-number" id="phoneDisplay">0777 151 6178</span>
            <a href="./signup.html" class="change-number">Not your number?</a>
        </div>

        <!-- OTP Inputs -->
        <div class="otp-inputs">
            <input type="tel" id="otp1" class="otp-input" maxlength="1">
            <input type="tel" id="otp2" class="otp-input" maxlength="1">
            <input type="tel" id="otp3" class="otp-input" maxlength="1">
            <input type="tel" id="otp4" class="otp-input" maxlength="1">
            <input type="tel" id="otp5" class="otp-input" maxlength="1">
            <input type="tel" id="otp6" class="otp-input" maxlength="1">
        </div>

        <!-- Resend -->
        <div id="resendText" style="margin-bottom: 30px;" class="resend">Resend code in 120 secs</div>

        <!-- Continue Button -->
        <button id="continueBtn" class="continue-button" disabled>Continue</button>
    </div>

<script>
// ========================================
// ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª API
// ========================================
const API_BASE = 'https://microcementazma.com/backend/api';

// ========================================
// ğŸ“ Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø§Ø² localStorage
// ========================================
const savedPhone = localStorage.getItem('phone_number');
const isLoginMode = localStorage.getItem('login_mode') === 'true';

console.log('ğŸ” Mode:', isLoginMode ? 'LOGIN' : 'REGISTRATION');
console.log('ğŸ“± Phone:', savedPhone);

if (!savedPhone) {
    console.error('âŒ No phone number found');
    window.location.href = isLoginMode ? './signin.html' : './signup.html';
}

// Ù†Ù…Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡ Ø¨Ø§ ÙØ±Ù…Øª
const formattedPhone = savedPhone.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
document.getElementById('phoneDisplay').textContent = formattedPhone;

// ========================================
// ğŸ¯ Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ù…Ù†Øªâ€ŒÙ‡Ø§
// ========================================
const inputs = document.querySelectorAll(".otp-input");
const continueBtn = document.getElementById("continueBtn");
const alertBoxError = document.getElementById("otpAlert");
const alertBoxSuccess = document.getElementById("otpAlertSuccess");
const resendEl = document.getElementById("resendText");
const changeNumberLink = document.querySelector('.change-number');

// ========================================
// ğŸ”„ ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†
// ========================================
if (changeNumberLink) {
    changeNumberLink.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('phone_number');
        localStorage.removeItem('login_mode');
        
        // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ù†Ø§Ø³Ø¨
        window.location.href = isLoginMode ? './signin.html' : './signup.html';
    });
}

// ========================================
// âš™ï¸ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ÛŒ
// ========================================
let otpCode = "";
let timer = 120;
let countdown;

// âœ… Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ localStorage Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù„Ø§Ú© Ú†Ù†Ø¯Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ
const BLOCK_10MIN_KEY = 'resend_blocked_10min';
const BLOCK_24H_KEY = 'resend_blocked_24h';
const RESEND_COUNT_KEY = 'resend_count';
const BLOCK_LEVEL_KEY = 'block_level';
const OTP_SENT_TIME_KEY = 'otp_sent_time'; // ğŸ”‘ Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ OTP

let resendCount = parseInt(localStorage.getItem(RESEND_COUNT_KEY) || '0');
let blockLevel = parseInt(localStorage.getItem(BLOCK_LEVEL_KEY) || '0');

const RESEND_LIMIT = 2; // Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø¨Ø§Ø± (0,1,2) Ø¨Ù„Ø§Ú© Ù…ÛŒâ€ŒØ´Ù‡

// ========================================
// ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ OTP
// ========================================
inputs.forEach((inp, idx) => {
    inp.addEventListener("input", (e) => {
        inp.value = inp.value.replace(/[^0-9]/g, '');
        
        if (inp.value.length === 1 && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
        }
        updateCode();
    });

    inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" || e.keyCode === 8) {
            if (idx > 0 && inp.value.length === 0) {
                e.preventDefault();
                const prevInput = inputs[idx - 1];
                prevInput.focus();
                prevInput.value = '';
                updateCode();
            }
        }
    });

    inp.addEventListener("focus", () => {
        inputs.forEach(el => {
            el.classList.remove("success", "error");
            el.classList.add("focus");
        });
    });

    inp.addEventListener("blur", () => {
        inp.classList.remove("focus");
    });
});

// ========================================
// ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø¯ OTP
// ========================================
function updateCode() {
    otpCode = Array.from(inputs).map(el => el.value).join("");
    
    if (otpCode.length === inputs.length) {
        continueBtn.classList.remove("disabled");
        continueBtn.disabled = false;
    } else {
        continueBtn.classList.add("disabled");
        continueBtn.disabled = true;
    }
}

// ========================================
// ğŸ“¡ ØªØ§ÛŒÛŒØ¯ OTP Ø¨Ø§ Ø³Ø±ÙˆØ±
// ========================================
async function verifyOTP(phoneNumber, otpCode) {
    try {
        console.log('ğŸ“¤ Sending verify request:', {
            phone_number: phoneNumber, 
            otp_code: otpCode,
            purpose: isLoginMode ? 'login' : 'registration'
        });
        
        const response = await fetch(`${API_BASE}/auth/verify-otp.php`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone_number: phoneNumber,
                otp_code: otpCode,
                purpose: isLoginMode ? 'login' : 'registration'
            })
        });
        
        const result = await response.json();
        console.log('ğŸ“¥ Verify Response:', result);
        
        // âœ… Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        if (result.success && result.data) {
            
            // Ø­Ø°Ù session_token Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¨Ù‡Ø§Ù… 
            localStorage.removeItem('session_token');
            
            // Ø°Ø®ÛŒØ±Ù‡ access_token 
            if (result.data.access_token) {
                localStorage.setItem('access_token', result.data.access_token);
                console.log('âœ… Access token saved');
            }
            
            // Ø°Ø®ÛŒØ±Ù‡ user_id 
            if (result.data.user_id) {
                localStorage.setItem('user_id', result.data.user_id);
                console.log('âœ… User ID saved');
            }
            
            // Ø°Ø®ÛŒØ±Ù‡ refresh_token
            if (result.data.refresh_token) {
                localStorage.setItem('refresh_token', result.data.refresh_token);
                console.log('âœ… Refresh token saved');
            }
        }
        
        return result;
    } catch (error) {
        console.error('âŒ Network Error:', error);
        return {
            success: false, 
            message: 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±'
        };
    }
}

// ========================================
// ğŸš€ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Continue
// ========================================
continueBtn.addEventListener("click", async () => {
    if (otpCode.length < 6) {
        console.warn('âš ï¸ OTP incomplete');
        return;
    }

    inputs.forEach(inp => inp.classList.remove("success", "error", "focus"));

    const originalText = continueBtn.textContent;
    continueBtn.textContent = '...Verifying';
    continueBtn.disabled = true;
    continueBtn.classList.add('disabled');
    
    console.log('ğŸ“¤ Verifying OTP:', otpCode);
    
    const cleanedPhone = savedPhone.replace(/\s/g, '');

    // ğŸ”‘ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ OTP Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§ÛŒÙ…Ø± ÙØ±Ø§Ù†Øªâ€ŒØ§Ù†Ø¯
    const otpSentTimestamp = localStorage.getItem(OTP_SENT_TIME_KEY);
    const currentTime = Date.now();

    if (otpSentTimestamp && (currentTime - parseInt(otpSentTimestamp)) / 1000 > 120) {
        console.warn('âš ï¸ Frontend: OTP Expired due to timer.');
        inputs.forEach(inp => inp.classList.add("error")); // Mark inputs as error visually
        
        const errorTitle = alertBoxError.querySelector('.otp-alert-title');
        const errorMessage = alertBoxError.querySelector('.otp-alert-message');
        
        if (errorTitle) {
            errorTitle.textContent = 'You are too late!';
        }
        if (errorMessage) {
            errorMessage.textContent = 'Code Expired. Please get a new code.';
        }
        showOtpAlert("error");
        
        continueBtn.textContent = originalText;
        continueBtn.disabled = false;
        continueBtn.classList.remove('disabled');
        
        setTimeout(() => {
            inputs.forEach(inp => {
                inp.value = '';
                inp.classList.remove("error");
            });
            inputs[0].focus();
            updateCode();
        }, 2000);
        return; // ğŸ›‘ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯
    }

    const result = await verifyOTP(cleanedPhone, otpCode);
    
    if (result.success) {
        console.log('âœ… OTP Verified Successfully');
        inputs.forEach(inp => inp.classList.add("success"));
        
        const successMessage = alertBoxSuccess.querySelector('.sss');
        if (successMessage) {
            successMessage.textContent = 'Verification successful.';
        }
        showOtpAlert("success");
        
        continueBtn.textContent = 'âœ“ Verified';
        
        // âœ… Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† login_mode Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù…ÙˆÙÙ‚
        localStorage.removeItem('login_mode');
        
        // âœ… Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø§Ú© Ùˆ Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ OTP Ø¨Ø¹Ø¯ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª
        localStorage.removeItem(RESEND_COUNT_KEY);
        localStorage.removeItem(BLOCK_LEVEL_KEY);
        localStorage.removeItem(BLOCK_10MIN_KEY);
        localStorage.removeItem(BLOCK_24H_KEY);
        localStorage.removeItem(OTP_SENT_TIME_KEY); // ğŸ”‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ OTP
        
        setTimeout(() => {
            // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ù†Ø§Ø³Ø¨
            if (isLoginMode) {
                // Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ùˆ
                window.location.href = './home.html';
            } else {
                // Ø§Ú¯Ø± Ø«Ø¨Øª Ù†Ø§Ù… Ø¨ÙˆØ¯ØŒ Ø¨Ù‡ onboarding Ø¨Ø±Ùˆ
                window.location.href = './onboarding.html';
            }
        }, 1000);
        
    } else {
        console.error('âŒ Verification Failed:', result.message);
        inputs.forEach(inp => inp.classList.add("error"));

        let alertTitle = 'Wrong code?';
        let alertMessage = 'Please double check and try again'; 
        
        if (result.data && result.data.code_expired === true) {
            alertTitle = 'You are too late!';
            alertMessage = 'Code Expired. Please get a new code.';
        }
        else if (result.data && result.data.too_many_attempts === true) {
            alertTitle = 'You are stubborn!';
            alertMessage = `Too many incorrect attempts.\n\nPlease try again in 10 minutes.`;
        }
        
        const errorTitle = alertBoxError.querySelector('.otp-alert-title');
        const errorMessage = alertBoxError.querySelector('.otp-alert-message');
        
        if (errorTitle) {
             errorTitle.textContent = alertTitle;
        }
        if (errorMessage) {
            errorMessage.textContent = alertMessage;
        }
        showOtpAlert("error");
        
        continueBtn.textContent = originalText;
        continueBtn.disabled = false;
        continueBtn.classList.remove('disabled');
        
        setTimeout(() => {
            inputs.forEach(inp => {
                inp.value = '';
                inp.classList.remove("error");
            });
            inputs[0].focus();
            updateCode();
        }, 2000);
    }
});

// ========================================
// ğŸ¨ Ù†Ù…Ø§ÛŒØ´ Alert
// ========================================
function showOtpAlert(type) {
    const alertEl = type === "success" ? alertBoxSuccess : alertBoxError;
    alertEl.classList.add("show");
    
    setTimeout(() => {
        alertEl.classList.remove("show");
    }, 3000);
}

// ========================================
// â±ï¸ ØªØ§ÛŒÙ…Ø± Resend
// ========================================
function startTimer() {
    clearInterval(countdown);
    
    resendEl.classList.remove("resend-link");
    resendEl.classList.add("resend");
    resendEl.style.pointerEvents = "none";
    
    timer = 120; 
    updateResendText();

    // ğŸ”‘ Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± (Ø§Ø±Ø³Ø§Ù„ OTP)
    localStorage.setItem(OTP_SENT_TIME_KEY, Date.now());

    countdown = setInterval(() => {
        timer--;
        updateResendText();

        if (timer <= 0) {
            clearInterval(countdown);
            resendEl.textContent = "Resend Code";
            resendEl.classList.remove("resend");
            resendEl.classList.add("resend-link");
            resendEl.style.pointerEvents = "auto";
        }
    }, 1000);
}

function updateResendText() {
    resendEl.textContent = `Resend code in ${timer} secs`;
}

// ========================================
// ğŸš¨ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
// ========================================
function showError(title, message) {
    const errorTitle = alertBoxError.querySelector('.otp-alert-title');
    const errorMessage = alertBoxError.querySelector('.otp-alert-message');
    
    if (errorTitle) errorTitle.textContent = title;
    if (errorMessage) errorMessage.textContent = message;
    
    showOtpAlert("error");
}

// ========================================
// ğŸ“¡ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ OTP
// ========================================
async function resendOTP() {
    const phoneNumber = localStorage.getItem('phone_number');
    if (!phoneNumber) return { success: false, message: 'No phone number' };
    
    const now = Date.now();
    
    // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡
    const BLOCK_10MIN_KEY = `resend_blocked_10min_${phoneNumber}`;
    const BLOCK_24H_KEY = `resend_blocked_24h_${phoneNumber}`;
    const COUNT_KEY = `resend_count_${phoneNumber}`;
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„Ø§Ú© 24 Ø³Ø§Ø¹ØªÙ‡
    const blocked24h = localStorage.getItem(BLOCK_24H_KEY);
    if (blocked24h && now < parseInt(blocked24h)) {
        const remaining = Math.ceil((parseInt(blocked24h) - now) / 60000);
        showError("That's enough for now!", `Try again in ${remaining} minutes.`);
        return { success: false, message: 'Blocked 24h' };
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„Ø§Ú© 10 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ
    const blocked10min = localStorage.getItem(BLOCK_10MIN_KEY);
    if (blocked10min && now < parseInt(blocked10min)) {
        const remaining = Math.ceil((parseInt(blocked10min) - now) / 60000);
        showError('You are stubborn!', `Try again in ${remaining} minutes.`);
        return { success: false, message: 'Blocked 10min' };
    }
    
    // Ø´Ù…Ø§Ø±Ø´ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§
    let resendCount = parseInt(localStorage.getItem(COUNT_KEY) || '0');
    resendCount++;
    localStorage.setItem(COUNT_KEY, resendCount);
    
    // Ø¨Ù„Ø§Ú© 24 Ø³Ø§Ø¹ØªÙ‡ Ø¨Ø¹Ø¯ Ø§Ø² 5 ØªÙ„Ø§Ø´
    if (resendCount >= 5) {
        const blockTime = now + (24 * 60 * 60 * 1000);
        localStorage.setItem(BLOCK_24H_KEY, blockTime);
        localStorage.setItem(COUNT_KEY, '0');
        showError("That's enough for now!", 'You are blocked for 24 hours.');
        return { success: false, message: 'Blocked after 5 attempts' };
    }
    
    // Ø¨Ù„Ø§Ú© 10 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² 3 ØªÙ„Ø§Ø´
    if (resendCount === 3) {
        const blockTime = now + (10 * 60 * 1000);
        localStorage.setItem(BLOCK_10MIN_KEY, blockTime);
        showError('You are stubborn!', 'Too many attempts. Try again in 10 minutes.');
        return { success: false, message: 'Blocked after 3 attempts' };
    }
    
   // Ø§Ø±Ø³Ø§Ù„ OTP
try {
    const response = await fetch(`${API_BASE}/auth/send-otp.php`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone_number: phoneNumber,
            purpose: localStorage.getItem('login_mode') === 'true' ? 'login' : 'registration'
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        startTimer(); // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ OTP_SENT_TIME_KEY Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        return { success: true, message: 'OTP sent successfully' };
    } else {
        showError('Error', result.message || 'Failed to resend OTP');
        return { success: false, message: result.message || 'Failed to resend OTP' };
    }
} catch (error) {
    showError('Network Error', 'Please check your connection');
    return { success: false, message: 'Network error' };
}

}




// ========================================
// ğŸš« Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù„Ø§Ú©
// ========================================
function checkBlockStatus() {
    const now = Date.now();
    
    // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„Ø§Ú© 24 Ø³Ø§Ø¹ØªÙ‡
    const blocked24h = localStorage.getItem(BLOCK_24H_KEY);
    if (blocked24h && now < parseInt(blocked24h)) {
        return {
            isBlocked: true,
            type: '24h',
            title: "That's enough for now!",
            message: "You've reached the limit for SMS requests. Please try again later."
        };
    } else if (blocked24h && now >= parseInt(blocked24h)) {
        // Ø²Ù…Ø§Ù† Ø¨Ù„Ø§Ú© 24 Ø³Ø§Ø¹ØªÙ‡ ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡
        localStorage.removeItem(BLOCK_24H_KEY);
        localStorage.removeItem(RESEND_COUNT_KEY);
        localStorage.removeItem(BLOCK_LEVEL_KEY);
        resendCount = 0;
        blockLevel = 0;
    }
    
    // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„Ø§Ú© 10 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ
    const blocked10min = localStorage.getItem(BLOCK_10MIN_KEY);
    if (blocked10min && now < parseInt(blocked10min)) {
        return {
            isBlocked: true,
            type: '10min',
            title: 'You are stubborn!',
            message: 'Too many incorrect attempts.\n\nPlease try again in 10 minutes.'
        };
    } else if (blocked10min && now >= parseInt(blocked10min)) {
        // Ø²Ù…Ø§Ù† Ø¨Ù„Ø§Ú© 10 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…ÙˆÙ… Ø´Ø¯Ù‡
        localStorage.removeItem(BLOCK_10MIN_KEY);
        
        // âœ… Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÛŒÚ© Ø¨Ø§Ø± Ø¨Ù„Ø§Ú© 10 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø´ØªÙ‡ØŒ Ø³Ø·Ø­ Ø¨Ù„Ø§Ú© Ø±Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (blockLevel === 0) {
            blockLevel = 1;
            localStorage.setItem(BLOCK_LEVEL_KEY, '1');
        }
        
        // Ø±ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ù‡ Ø¨Ø¹Ø¯ÛŒ
        resendCount = 0;
        localStorage.setItem(RESEND_COUNT_KEY, '0');
    }
    
    return { isBlocked: false };
}

// ========================================
// ğŸ”„ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Resend (Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø³Ù„Ú©ØªÙˆØ±)
// ========================================
resendEl.addEventListener("click", async () => {
    // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª
    if (!resendEl.classList.contains("resend-link")) return;
    
    // âœ… Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø§Ø±Ø³Ø§Ù„
    resendEl.textContent = "...Sending";
    resendEl.style.pointerEvents = "none";
    
    // âœ… ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ resendOTP
    const result = await resendOTP();
    
    // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡
    if (result.success) {
        // Ù…ÙˆÙÙ‚ÛŒØª - ØªØ§ÛŒÙ…Ø± Ø§Ø² Ø¯Ø§Ø®Ù„ resendOTP Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡
        
        // ğŸ› ï¸ Ø§ØµÙ„Ø§Ø­: ÙÙ‚Ø· Ø¹Ù†ØµØ± .sss Ø¯Ø± Ø¨Ø§Ú©Ø³ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
        const successMessageEl = alertBoxSuccess.querySelector('.sss'); 
        
        if (successMessageEl) {
            successMessageEl.textContent = 'A new verification code has been sent.';
        }
        
        showOtpAlert("success");
    } else {
        // Ø®Ø·Ø§ - Ù¾ÛŒØºØ§Ù… Ø§Ø² Ø¯Ø§Ø®Ù„ resendOTP Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
        resendEl.textContent = "Resend Code";
        resendEl.style.pointerEvents = "auto";
        resendEl.classList.add("resend-link");
    }
});


// ========================================
// âš¡ Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
// ========================================
window.addEventListener('load', () => {
    // âœ… Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù„Ø§Ú© Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
    const blockStatus = checkBlockStatus();
    
    if (blockStatus.isBlocked) {
        const errorTitle = alertBoxError.querySelector('.otp-alert-title');
        const errorMessage = alertBoxError.querySelector('.otp-alert-message');
        
        errorTitle.textContent = blockStatus.title;
        errorMessage.textContent = blockStatus.message;
        
        showOtpAlert("error");
    }
    
    startTimer();
    inputs[0].focus();
});



</script>

</body>
</html>
